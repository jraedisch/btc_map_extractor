<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BTC Map Extractor</title>
    <style>
      form {
        padding: 16px 0;
      }
      label {
        display: block;
      }
      table {
        border-collapse: collapse;
        border: 1px solid black;
      }
      td {
        border: 1px solid black;
        padding: 8px;
      }
      thead td {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>
      Entries on
      <a href="https://btcmap.org/">BTC Map</a>
      filterable by addr:city
    </h1>
    <p>Click on headers to sort.</p>
    <form method="GET">
      <label for="city">City (case sensitive, leave empty for all):</label>
      <input type="text" name="city" id="city" placeholder="E.g. Hamburg" />
      <input type="submit" />
    </form>
    <table id="table">
      <thead>
        <tr id="headers">
          <td>Edit</td>
        </tr>
      </thead>
      <tbody id="elements"></tbody>
    </table>
    <p>by <a href="https://mobile.twitter.com/jraedisch">@jraedisch</a></p>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.2.1/tablesort.min.js"
      integrity="sha512-F/gIMdDfda6OD2rnzt/Iyp2V9JLHlFQ+EUyixDg9+rkwjqgW1snpkpx7FD5FV1+gG2fmFj7I3r6ReQDUidHelA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script>
      var params = new URLSearchParams(window.location.search);
      var city = params.get("city");
      document.getElementById("city").value = city;
      var osm_tags = [
        "name",
        "contact:website",
        "website",
        "contact:email",
        "contact:phone",
        "addr:country",
        "addr:city",
        "addr:postcode",
        "addr:street",
        "addr:housenumber",
        "amenity",
        "office",
        "payment:lightning",
        "payment:onchain",
        "currency:XBT",
        "opening_hours",
        "diet:vegetarian",
        "operator",
        "tourism",
        "wheelchair",
        "capacity",
        "cuisine",
        "shop",
        "takeaway",
        "note",
        "survey.date",
      ];
      function initTableHeaders(titles) {
        var headers = document.getElementById("headers");
        titles.forEach((title) => {
          var header = document.createElement("td");
          header.appendChild(document.createTextNode(title));
          headers.appendChild(header);
        });
      }
      initTableHeaders(osm_tags);
      new Tablesort(document.getElementById("table"));
      function elementValid(element) {
        return element && element.osm_json && element.osm_json.tags;
      }
      function extractElementsByCityTag(elements, city) {
        var filtered = [];
        var all_cities = !city || city === "";
        elements.forEach((element) => {
          if (
            elementValid(element) &&
            (all_cities || element.osm_json.tags["addr:city"] === city)
          ) {
            filtered.push(element);
          }
        });
        return filtered;
      }
      function appendElements(elements) {
        var container = document.getElementById("elements");
        elements.forEach((element) => {
          container.appendChild(buildRow(element));
        });
      }
      function buildRow(element) {
        var tr = document.createElement("tr");
        var td = document.createElement("td");
        var a = document.createElement("a");
        a.href =
          "https://www.openstreetmap.org/edit?node=" + element.osm_json.id;
        a.appendChild(document.createTextNode("edit"));
        td.appendChild(a);
        tr.appendChild(td);

        osm_tags.forEach((tag) => {
          var td = document.createElement("td");
          var content = element.osm_json.tags[tag];
          td.appendChild(document.createTextNode(content ? content : ""));
          tr.appendChild(td);
        });
        return tr;
      }
      fetch("https://api.btcmap.org/v2/elements", { cache: "reload" })
        .then((resp) => resp.json())
        .then((elements) => {
          var filtered = extractElementsByCityTag(elements, city);
          appendElements(filtered);
        });
    </script>
  </body>
</html>
